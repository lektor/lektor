name: Tests master

on:
  # This avoids having duplicate builds for a pull request
  push:
    branches:
    - master
  pull_request:
    branches:
    - master

jobs:
  ############################################################################
  # Close previous builds on the same branch
  ############################################################################
  cleanup-previous-runs:
    name: Cleanup previous builds
    runs-on: ubuntu-latest
    steps:
      - uses: rokroskar/workflow-run-cleanup-action@master
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"


  ############################################################################
  # Lint jobs
  ############################################################################
  lint-py:
    name: Lint Python
    needs: cleanup-previous-runs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false 
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Fetch branches and tags
        run: git fetch --prune --unshallow
      - name: Check build skip
        run: source .github/scripts/check_skip.sh
      - name: Check py skip
        run: source .github/scripts/check_py_skip.sh
      - name: Cache pip
        uses: actions/cache@v1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py-3.8-pip-${{ hashFiles('**/setup.py') }}
      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: '3.8'
          architecture: 'x64'
      - name: Install python dependencies
        run: python -m pip install --editable .[test]
      - name: Show python environment
        run: |
          python --version
          python -m pip list
      - name: Run python lint
        run: pylint lektor

  lint-js:
    name: Lint JS
    needs: cleanup-previous-runs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Fetch branches and tags
        run: git fetch --prune --unshallow
      - name: Check build skip
        run: source .github/scripts/check_skip.sh
      - name: Check js skip
        run: source .github/scripts/check_js_skip.sh
      - name: Cache node
        uses: actions/cache@v1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-13-${{ hashFiles('**/lektor/admin/package-lock.json') }}
      - name: Setup node
        uses: actions/setup-node@v1
        with:
          node-version: '13'
      - name: Install node dependencies
        run: |
          cd lektor/admin/
          npm install .
          npm run webpack
      - name: Show node environment
        run: |
          node --version
          npm --version
      - name: Run JS lint
        run: |
          cd lektor/admin/
          npm run lint
